
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ตรวจสอบพื้นที่จัดส่งพัสดุ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .text-sm {
            font-size: 10pt;
        }
        .text-md {
            font-size: 12pt;
        }
        .routeCode{
            cursor: pointer;
        }
        .routeCode:hover{
            background-color: aqua;
        }

 
    
        .grow {
            animation-name: spin;
  animation-duration: 500ms;
  animation-iteration-count: infinite;
  animation-timing-function: linear; 
        }

        @keyframes spin {
  0% {
    transform: scale(0);
  }
  50% {
    opacity: 1;
    transform: none;
  }
}

    </style>
</head>
  <body>
    <div class="container-md mt-3 text-center" id="bodyLoad">
    <h3 class="mt-5">สถานะพื้นที่การจัดส่งพัสดุของเคอรี่</h1>
    <p class="text-md text-danger" id="status"></p>
    <p class="text-sm" id="updated"></p>

    <div class="my-5">
        <button class="btn btn-sm btn-danger" type="button" id="close">พื้นที่งดจัดส่ง</button>
        <button class="btn btn-sm btn-warning" type="button" id="delayed">พื้นที่ล่าช้า</button>
        <button class="btn btn-sm btn-warning" type="button" id="block">พัสดุขนาดใหญ่ล่าช้า</button>

    </div>


    <div class="input-group mb-3">
    <span class="input-group-text"><span class="material-symbols-outlined">explore</span></span>
    <input type="text" class="form-control" placeholder="ค้นหาพื้นที่">
    <button class="btn btn-outline-secondary" type="button" id="search">Search</button>
    </div>

    <div id="response"></div>


    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="js/fetch.js"></script>
  
<script>

document.querySelector("#updated").innerHTML = 'Last updated: '+new Date().toJSON().slice(0,10).replace(/-/g,'-');

document.querySelector("#search").addEventListener("click", async () => {
    const response = await API({"action":"search","value":document.querySelector("input").value})
    document.querySelector("#response").innerHTML = render(response)
    routeCode()
});

document.querySelector("input").addEventListener("keydown", async (e) => {
    if (e.key === 'Enter') {
        const response = await API({"action":"search","value":document.querySelector("input").value})
        document.querySelector("#response").innerHTML = render(response)
        routeCode()
    }
});

document.querySelector("#close").addEventListener("click", async () => {
    document.querySelector("input").value=''
    const response = await API({"action":"close"})
    document.querySelector("#response").innerHTML = render(response)
    routeCode()
});
document.querySelector("#delayed").addEventListener("click", async () => {
    document.querySelector("input").value=''
    const response = await API({"action":"delayed"})
    document.querySelector("#response").innerHTML = render(response)
    routeCode()
});
document.querySelector("#block").addEventListener("click", async () => {
    document.querySelector("input").value=''
    const response = await API({"action":"block"})
    document.querySelector("#response").innerHTML = render(response)
    routeCode()
});


function routeCode() {

    document.querySelectorAll(".routeCode").forEach(function(element){
        element.addEventListener("click", async () => {
            document.querySelector("input").value=element.innerHTML
            const response = await API({"action":"search",value:element.innerHTML})
            document.querySelector("#response").innerHTML = render(response)
            routeCode()
        })
    })
}

function render(response){
   
    if(!response.data.length){ return `<div class="text-danger mt-4">ไม่พบข้อมูลการส่งพัสดุไปยังพื้นที่ดังกล่าว หรือ เป็นพื้นที่งดรับพัสดุชั่วคราว</div>`;}

  //  document.querySelector("#updated").innerHTML = JSON.stringify(response.report)

  var d = new Date();
    d.setDate(d.getDate()-7);

    let status = ''
    let count_inactive = 0
    let count_capacities = 0
    let count_BlockSize = 0
    let cpost = ''
    let html = `
    <div class="text-start text-info text-sm"><p>หมายเหตุ: ข้อมูลพัสดุจาก KBD โดยการสุ่มเช็คสถานะพัสดุ ที่ส่งเข้าระบบตั้งแต่วันที่ ${(d.toLocaleString('en-GB', { timeZone: 'UTC' }).split(','))[0]} จำนวน 20,000 ชิ้น ทั่วประเทศ</p></div>
    
    <table class="table table-sm table-striped table-hover">`
    response.data.forEach(element => {
        let icon = `<span class="material-symbols-outlined text-success">where_to_vote</span>`


        if(element.masterBlockSize.length){
            count_BlockSize++
            icon = `<span class="material-symbols-outlined text-warning grow">emergency_heat</span>`
            element.warningMessage = (!element.warningMessage)?`<span class="material-symbols-outlined me-2">local_shipping</span> <span class="text-sm">พัสดุขนาดใหญ่อาจล่าช้า</span>`:element.warningMessage
            status = `พื้นที่ปลายทาง ${count_BlockSize} ตำบล จัดส่งพัสดุขนาดใหญ่อาจล่าช้า`
        }

        if(element.masterPostalCodeCapacities){
            count_capacities++
            icon = `<span class="material-symbols-outlined text-danger grow">emergency_heat</span>`
            element.warningMessage = (!element.warningMessage)?`<span class="material-symbols-outlined me-2">trolley</span> <span class="text-sm">พัสดุทุกขนาดอาจล่าช้า</span>`:element.warningMessage
            status = `พื้นที่ปลายทาง ${count_capacities} ตำบล จัดส่งพัสดุทุกขนาดอาจล่าช้า`
        }

        if(element.inactive){
            count_inactive++
            icon = `<span class="material-symbols-outlined text-danger">wrong_location</span>`
            status = `พื้นที่ปลายทาง ${count_inactive} ตำบล ไม่สามารถออกนำจ่ายได้ งดรับพัสดุไปยังปลายทางดังกล่าวชั่วคราว`
        }
       

        if(element.postalCode!=cpost){
            cpost=element.postalCode

            let report = response.report.find((element) => (element.postcode==cpost)??element)

            if(!report.con_total) return

            
             html += `<tr class="p-0">
            <td colspan="7" class="pt-3 text-md-start bg-light">

                
                <div class="bg-light d-md-flex justify-content-between">


                <div class="d-md-flex align-items-center gap-1">

                <span class="badge text-bg-light">รหัสไปรษณีย์ ${report.postcode} สุ่มตรวจจำนวน: ${report.con_total||0} ชิ้น</span>
                </div>
               

               <div class="d-md-flex align-items-center gap-2">
        
                <span class="px-2 text-bg-success">ส่งสำเร็จ: ${number_format(((report.con_success||0)/report.con_total)*100,2)}%</span>
                <span class="px-2 text-bg-danger">ไม่สำเร็จ: ${number_format(((report.con_unsuccess||0)/report.con_total)*100,2)}%</span>

                </div>
               

                <div class="d-md-flex align-items-center gap-1">

                <span class="material-symbols-outlined text-md">local_shipping</span>

                <span class="badge text-bg-light">ND : ${report.ND||0}</span>

                <span class="badge text-bg-light">2D : ${report['2D']||0}</span>

                <span class="badge text-bg-light">3D : ${report['3D']||0}</span>

                <span class="badge text-bg-light">4D : ${report['4D']||0}</span>

                <span class="badge text-bg-light">5D : ${report['5D']||0}</span>
                
                <span class="badge text-bg-light">OD : ${report['OD']||0}</span>
                </div>

                
                </div>
            </td>
           </tr>`

        }

      

        html += `<tr>
            <td>${icon??''}</td>
            <td class="align-middle ">${element.district}</td>
            <td class="align-middle d-none d-md-table-cell">${element.amphur}</td>
            <td class="align-middle d-none d-md-table-cell">${element.province}</td>
            <td class="align-middle d-none d-md-table-cell">${element.postalCode}</td>
            <td class="align-middle text-danger text-sm">${(element.esaSurcharged=="1")?`พื้นที่ห่างไกล +50 บาท `:''}${element.warningMessage??''}</td>
            <td class="text-end align-middle d-none d-md-table-cell"><div class="text-sm text-info"><span class="material-symbols-outlined me-2 text-md">warehouse</span><span class="badge bg-light text-dark pointer routeCode">${element.linehualRoute}</span> <span class="badge bg-light text-dark pointer routeCode">${element.routeCode}</span></div></td>
            </tr>`
    });
    html += `</table>
    
    <div class="text-start text-dark text-sm">* อัตราการส่งสำเร็จคำนวนจาก พัสดุที่นำส่งสำเร็จทั้งหมด (ส่งช้า 5-6 วัน ก็นับหากพัสดุชิ้นนั้น มีสถานะจัดส่งสำเร็จ)</div>
    <div class="text-start text-dark text-sm">** อัตราการส่งไม่สำเร็จคำนวนจาก พัสดุตีกลับ ไม่สามารถติดต่อผู้รับได้ ผู้รับปฏิเสธรับพัสดุ พัสดุเสียหาย พัสดุส่งทำลาย อื่นๆ</div>
    <div class="text-start text-dark text-sm">*** อัตราความสำเร็จนี้มาจากการสุ่มพัสดุมาเพียงเล็กน้อยจากพัสดุทั้งหมดในคลัง อาจบังเอินได้ว่าสุ่มเจอพัสดุที่มีปัญหา จึงทำให้ % ไม่สำเร็จมีสูง โปรดใช้วิจารณญาณในการวิเคราะห์อีกครั้ง โดยพิจารณาจากจำนวนพัสดุที่สุ่มเลขขึ้นมาตรวจ</div>

    `

    document.querySelector("#status").innerHTML = status

    return html
}

function number_format(number_input=0, decimal_places=0, separator=',') {
    const formatted = parseFloat(number_input).toFixed(decimal_places).split(".");
    const processing = separator===','
                    ?formatted[0].replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")
                    :formatted[0].replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+separator)
    return String(processing+(formatted[1]?'.'+formatted[1]:""))
}

</script>
</body>
</html>
