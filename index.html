
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ตรวจสอบพื้นที่จัดส่งพัสดุ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
    <style>
        body { 
            background-image: url('img/bg-main.png');
            background-attachment: fixed;
            background-position-x: center;
            background-position-y: top;
            background-repeat: no-repeat;
            background-size: 100%;
            font-family: 'Kanit', sans-serif; 
        }
        .text-sm {
            font-size: 10pt;
        }
        .text-md {
            font-size: 12pt;
        }
        .routeCode{
            cursor: pointer;
        }
        .pointer{
            cursor: pointer;
            background-color: rgb(255, 218, 172);
        }
        .pointer:hover{
            cursor: pointer;
            background-color: rgb(255, 174, 0);
        }
        .grow {
            animation-name: spin;
            animation-duration: 500ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear; 
        }
        .bgcustom{
            background: rgba(255, 255, 255, .8);
        }

        @keyframes spin {
            0% {
                transform: scale(0);
            }
            50% {
                opacity: 1;
                transform: none;
            }
        }
    </style>
</head>
  <body>
    <div class="container-md mt-3 py-4 text-center bgcustom rounded" id="bodyLoad">
    <h3 class="mt-5">ระบบตรวจเช็กสถานะการจัดส่งพัสดุ</h1>
    <p class="text-md text-danger" id="status"></p>
    <p class="text-sm" id="updated"></p>

    <div class="my-5 d-flex justify-content-center gap-3">
        <button class="btn btn-sm btn-outline-warning" type="button" id="block"># พื้นที่งดจัดส่ง/ล่าช้า ตามประกาศเคอรี่ (Official)</button>
    </div>

    <div class="input-group mb-3">
    <span class="input-group-text"><span class="material-symbols-outlined">explore</span></span>
    <input type="text" class="form-control" placeholder="ค้นหาพื้นที่">
    <button class="btn btn-outline-secondary" type="button" id="search">Search</button>
    </div>

    <div id="response"></div>

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-fullscreen-sm-down">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">รายละเอียดสถานะการจัดส่งรหัส <span class="postcode"></span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <div class="" id="status1"></div>
            <div class="mt-4 text-start text-dark bg-warning rounded p-2 mb-1 btn btn-sm" data-bs-toggle="collapse" href="#collapseExample">KBD ลงทะเบียนเข้าร่วมโครงการ ฟรี!</div>
            <div class="collapse mt-2" id="collapseExample">
                <div class="card card-body" id="joinReturn">
                    <div class="text-start text-sm text-primary"><p>ลงทะเบียนโดยใส่รหัสประจำสาขาเคอรี่บัดดี้เท่านั้น!<br>ถือเป็นการยินยอมให้ระบบเข้าถึงเลขพัสดุจากสาขาของท่าน และระบบทำการเช็คข้อมูลสถานะการจัดส่งทุกวัน</p></div>
                    <div class="input-group">
                        <input type="text" id="kbdInput" class="form-control" placeholder="รหัสสาขา KBXXXX" aria-label="KBXXXX" aria-describedby="button-addon2" maxlength="5">
                        <button class="btn btn-success" type="button" id="joinUs">Submit</button>
                      </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="js/fetch.js"></script>
<script>
    document.querySelector("#updated").innerHTML = 'Last updated: ' + new Date().toJSON().slice(0, 10).replace(/-/g, '-');

    document.querySelector("#search").addEventListener("click", async () => {
        const response = await API({ "action": "search", "value": document.querySelector("input").value })
        document.querySelector("#response").innerHTML = render(response)
        routeCode()
    });

    document.querySelector("input").addEventListener("keydown", async (e) => {
        if (e.key === 'Enter') {
            const response = await API({ "action": "search", "value": document.querySelector("input").value })
            document.querySelector("#response").innerHTML = render(response)
            routeCode()
        }
    });

    document.querySelector("#block").addEventListener("click", async () => {
        document.querySelector("input").value = ''
        const response = await API({ "action": "official" })
        document.querySelector("#response").innerHTML = render(response)
        routeCode()
    });

    document.querySelector("#joinUs").addEventListener("click", async () => {
        const value = document.querySelector("#kbdInput").value
        if (value.length !== 5) { return }
        document.querySelector("#kbdInput").disabled = true;
        document.querySelector("#joinUs").disabled = true;
        const response = await API({ "action": "join", "value": value })
        document.querySelector("#joinReturn").innerHTML = '<div class="text-success">ขอบคุณที่เข้าร่วม การเข้าร่วมครั้งนี้ของท่านจะทำให้ระบบมีข้อมูลที่แม่นยำมากยิ่งขึ้น</div>'
    });



    function routeCode() {

        document.querySelectorAll(".routeCode").forEach(function (element) {
            element.addEventListener("click", async () => {
                document.querySelector("input").value = element.innerHTML
                const response = await API({ "action": "search", value: element.innerHTML })
                document.querySelector("#response").innerHTML = render(response)
                routeCode()
            })
        })

        document.querySelectorAll(".getModal").forEach(function (element) {
            element.addEventListener("click", function () {
                const data = JSON.parse(window.atob(this.dataset.id));

                const date = new Date()
                const days14Ago = new Date(date.getTime());
                const yesterday = new Date(date.getTime());
                days14Ago.setDate(date.getDate() - 14)
                yesterday.setDate(date.getDate() - 1)


                document.querySelector(".postcode").innerHTML = data.postcode
                document.querySelector("#status1").innerHTML = `
<div class="text-start text-primary">สาขาที่เข้าร่วมโครงการกับเรา ได้มีการส่งพัสดุไปยังรหัสไปรษณีย์ ${data.postcode} จำนวน ${data.con_total} ชิ้น</div>
<div class="text-start text-dark text-sm">จากข้อมูลพัสดุที่สแกนออกจากสาขาตั้งแต่วันที่ ${((days14Ago.toLocaleString('en-GB', { timeZone: 'UTC' })).split(', '))[0]} ถึง ${((yesterday.toLocaleString('en-GB', { timeZone: 'UTC' })).split(', '))[0]}</div>
<div class="mt-3 row gap-2">
    <div class="col col-lg-5 card card-body">
        <div class="text-start text-primary">พัสดุที่จัดส่งสำเร็จแล้ว รวม ${data.con_success} ชิ้น</div>
        <div class="mt-2 text-start text-${(data['ND'] > 0) ? 'success' : 'dark'} text-sm">ND = ${data.ND} ชิ้น (ส่งสำเร็จ ภายในวันถัดไป)</div>
        <div class="text-start text-${(data['2D'] > 0) ? 'success' : 'dark'} text-sm">2D = ${data['2D']} ชิ้น</div>
        <div class="text-start text-${(data['3D'] > 0) ? 'warning' : 'dark'} text-sm">3D = ${data['3D']} ชิ้น</div>
        <div class="text-start text-${(data['4D'] > 0) ? 'warning' : 'dark'} text-sm">4D = ${data['4D']} ชิ้น</div>
        <div class="text-start text-${(data['5D'] > 0) ? 'warning' : 'dark'} text-sm">5D = ${data['5D']} ชิ้น</div>
        <div class="text-start text-${(data['OD'] > 0) ? 'warning' : 'dark'} text-sm">6D = ${data['OD']} ชิ้น (ส่งสำเร็จ โดยใช้เวลามากกว่า 5 วัน)</div>
    </div>
    <div class="col col-lg-5 card card-body">
        <div class="text-start text-primary">พัสดุที่กำลังจัดส่ง รวม ${data.con_pending} ชิ้น</div>
        <div class="mt-2 text-start text-${(data['pending_ND'] > 0) ? 'success' : 'dark'} text-sm">1 วัน = ${data.pending_ND} ชิ้น</div>
        <div class="text-start text-${(data['pending_2D'] > 0) ? 'success' : 'dark'} text-sm">2 วัน = ${data.pending_2D} ชิ้น</div>
        <div class="text-start text-${(data['pending_3D'] > 0) ? 'warning' : 'dark'} text-sm">3 วัน = ${data.pending_3D} ชิ้น</div>
        <div class="text-start text-${(data['pending_4D'] > 0) ? 'danger' : 'dark'} text-sm">4 วัน = ${data.pending_4D} ชิ้น</div>
        <div class="text-start text-${(data['pending_5D'] > 0) ? 'danger' : 'dark'} text-sm">5 วัน = ${data.pending_5D} ชิ้น</div>
        <div class="text-start text-${(data['pending_OD'] > 0) ? 'danger' : 'dark'} text-sm">6 วัน = ${data.pending_OD} ชิ้น (พัสดุตกค้าง+ช้ามากกว่า 5 วัน)</div>
    </div>

<div class="col card card-body">
    <div class="text-start text-${(data['con_unsuccess'] > 0) ? 'danger' : 'dark'} text-sm">พัสดุตีกลับ, ลูกค้าปฎิเสธรับ, เกินกำหนดส่ง, ตีกลับอัตโนมัติ, พัสดุสูญหาย+เสียหาย = ${data.con_unsuccess} ชิ้น</div>
</div>

</div>`
            });
        });

    }

    function render(response) {

        if (!response.data.length) { return `<div class="text-danger mt-4">ไม่พบข้อมูลการส่งพัสดุไปยังพื้นที่ดังกล่าว หรือ เป็นพื้นที่งดรับพัสดุชั่วคราว</div>`; }

        let status = ''
        let checkPost = ''
        let html = `<table class="table table-sm table-striped table-hover">`
        let icon = ``

        response.data.forEach(element => {

            if (element.masterBlockSize.length) {
                element.warningMessage = (!element.warningMessage) ? `<span class="text-sm">พัสดุขนาดใหญ่อาจล่าช้า</span>` : element.warningMessage
            }

            if (element.masterPostalCodeCapacities) {
                element.warningMessage = (!element.warningMessage) ? `<span class="text-sm">พัสดุทุกขนาดอาจล่าช้า</span>` : element.warningMessage
            }

           

            if (element.postalCode != checkPost) {
                checkPost = element.postalCode
                let report = response.report.find((element) => (element.postcode == checkPost) ?? element)

             
                if (!report.con_total) return

                html += `<tr class="p-0">
            <td colspan="7" class="p-0 text-md-start bg-light">
                <div class="d-md-flex justify-content-between p-2 pointer getModal" data-bs-toggle="modal" data-bs-target="#exampleModal" data-id="${window.btoa(JSON.stringify(report))}">
                    <div class="d-md-flex align-items-center gap-1">
                        <span class="badge text-dark">รหัสไปรษณีย์ ${report.postcode} จำนวน: ${report.con_total || 0} ชิ้น</span>
                    </div>
                    <div class="d-md-flex align-items-center gap-1">
                        <span class="badge text-bg-light">ND : ${number_format(((report.ND || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                        <span class="badge text-bg-light">2D : ${number_format(((report['2D'] || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                        <span class="badge text-bg-light">3D : ${number_format(((report['3D'] || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                        <span class="badge text-bg-light">4D : ${number_format(((report['4D'] || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                        <span class="badge text-bg-light">5D : ${number_format(((report['5D'] || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                        <span class="d-none d-md-inline badge text-bg-light">6D : ${number_format(((report['OD'] || 0) / (report.con_success || 1)) * 100, 0)}%</span>
                    </div>
                </div>
            </td>
           </tr>`

            if(report['3D']>3||report['4D']>1||report['5D']>1||report['OD']>1||report['pending_3D']>1||report['pending_4D']>1||report['pending_5D']>1||report['pending_OD']>1){
                icon = `<span class="material-symbols-outlined text-warning grow">location_on</span>`
            }else{
                icon = `<span class="material-symbols-outlined text-success">location_on</span>`
            }
            if (element.inactive) {
                    icon = `<span class="material-symbols-outlined text-danger grow">wrong_location</span>`
            }
            }



            html += `<tr>
            <td>${icon ?? ''}</td>
            <td class="align-middle ">${element.district}</td>
            <td class="align-middle d-none d-md-table-cell">${element.amphur}</td>
            <td class="align-middle d-none d-lg-table-cell">${element.province}</td>
            <td class="align-middle d-none d-md-table-cell">${element.postalCode}</td>
            <td class="align-middle text-danger text-sm">${element.warningMessage ?? ''} ${(element.esaSurcharged == "1") ? ` + พื้นที่ห่างไกล` : ''}</td>
            <td class="text-end align-middle d-none d-lg-table-cell"><div class="text-sm text-info"><span class="badge bg-light text-dark pointer routeCode">${element.linehualRoute}</span> <span class="badge bg-light text-dark pointer routeCode">${element.routeCode}</span></div></td>
            </tr>`
        });
        html += `</table>`
        document.querySelector("#status").innerHTML = status
        return html
    }

    function number_format(number_input = 0, decimal_places = 0, separator = ',') {
        const formatted = parseFloat(number_input).toFixed(decimal_places).split(".");
        const processing = separator === ','
            ? formatted[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,")
            : formatted[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1" + separator)
        return String(processing + (formatted[1] ? '.' + formatted[1] : ""))
    }

</script>
</body>
</html>
